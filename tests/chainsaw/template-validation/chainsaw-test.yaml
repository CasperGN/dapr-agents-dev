apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: template-validation
spec:
  description: Validate helm template renders valid Kubernetes manifests
  timeouts:
    apply: 15m
    assert: 2m
    delete: 5m
    exec: 15m
  steps:
    # Render with minimal config (own templates only, no sub-charts)
    - name: render-minimal
      try:
        - command:
            entrypoint: bash
            args:
              - -c
              - |
                SKIP="CustomResourceDefinition"
                SKIP="$SKIP,Component,HTTPEndpoint"
                SKIP="$SKIP,Agent,Memory,ModelConfig"
                SKIP="$SKIP,RemoteMCPServer,ToolServer"
                SKIP="$SKIP,MCPServer,Configuration"

                helm template dapr-agents ../../../dapr-agents \
                  --namespace dapr-agents \
                  --set monitoring.enabled=false \
                  --set kagent.enabled=false \
                  --set dapr.enabled=false \
                  --set llm.apiKey=test-key \
                  | kubeconform -strict -summary \
                    -schema-location default \
                    -skip "$SKIP"

    # Render with dapr enabled
    - name: render-with-dapr
      try:
        - command:
            entrypoint: bash
            args:
              - -c
              - |
                SKIP="CustomResourceDefinition"
                SKIP="$SKIP,Component,HTTPEndpoint"
                SKIP="$SKIP,Agent,Memory,ModelConfig"
                SKIP="$SKIP,RemoteMCPServer,ToolServer"
                SKIP="$SKIP,MCPServer,Configuration"

                helm template dapr-agents ../../../dapr-agents \
                  --namespace dapr-agents \
                  --set monitoring.enabled=false \
                  --set kagent.enabled=false \
                  --set llm.apiKey=test-key \
                  | kubeconform -strict -summary \
                    -schema-location default \
                    -skip "$SKIP"

    # Render with full values (all features enabled)
    - name: render-full
      try:
        - command:
            entrypoint: bash
            args:
              - -c
              - |
                SKIP="CustomResourceDefinition"
                SKIP="$SKIP,Component,HTTPEndpoint"
                SKIP="$SKIP,ServiceMonitor,Alertmanager"
                SKIP="$SKIP,AlertmanagerConfig,PodMonitor"
                SKIP="$SKIP,Probe,PrometheusAgent"
                SKIP="$SKIP,Prometheus,PrometheusRule"
                SKIP="$SKIP,ScrapeConfig,ThanosRuler"
                SKIP="$SKIP,Agent,Memory,ModelConfig"
                SKIP="$SKIP,RemoteMCPServer,ToolServer"
                SKIP="$SKIP,MCPServer,Configuration"

                helm template dapr-agents ../../../dapr-agents \
                  --namespace dapr-agents \
                  --set llm.apiKey=test-key \
                  > full-template.yaml

                kubeconform -strict -summary \
                  -schema-location default \
                  -skip "$SKIP" < full-template.yaml

                # Verify gateway subdomain links
                grep "kagent.localhost" full-template.yaml
                grep "grafana.localhost" full-template.yaml
                grep "redis.localhost" full-template.yaml
                grep "diagrid.localhost" full-template.yaml

apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: redis-seed
spec:
  description: Validate redis-seed job populated the agent_runtime hash
  namespace: dapr-agents
  timeouts:
    assert: 5m
    exec: 5m
  steps:
    - name: verify-agent-runtime-hash
      try:
        - script:
            content: |
              echo "Checking agent_runtime hash in Redis..."

              # Retrieve the password from the secret
              REDIS_PASS=$(kubectl get secret dapr-redis \
                -n dapr-agents \
                -o jsonpath='{.data.redis-password}' | base64 -d)
              AUTH=""
              if [ -n "$REDIS_PASS" ]; then AUTH="-a $REDIS_PASS"; fi

              REDIS_HOST="dapr-redis-master.dapr-agents.svc.cluster.local"

              # Run redis-cli inside the cluster via a temporary pod
              RESULT=$(kubectl run redis-check --rm -i --restart=Never \
                --namespace dapr-agents \
                --image=redis:6.2 \
                -- redis-cli -h "$REDIS_HOST" $AUTH HGETALL agent_runtime 2>/dev/null)

              echo "Raw result:"
              echo "$RESULT"

              # Verify key fields exist
              echo "$RESULT" | grep -q "version" || { echo "FAIL: 'version' field missing"; exit 1; }
              echo "$RESULT" | grep -q "data" || { echo "FAIL: 'data' field missing"; exit 1; }
              echo "$RESULT" | grep -q "OTEL_ENABLED" || { echo "FAIL: OTEL_ENABLED not found in data"; exit 1; }
              echo "$RESULT" | grep -q "OTEL_ENDPOINT" || { echo "FAIL: OTEL_ENDPOINT not found in data"; exit 1; }

              echo "Redis seed verification passed"

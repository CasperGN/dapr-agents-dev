apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: core-install
spec:
  description: Validate core dapr-agents chart resources exist
  namespace: dapr-agents
  timeouts:
    assert: 30m
    exec: 15m
  steps:
    # Wait for all key deployments to become ready
    - name: wait-for-readiness
      try:
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: dapr-redis
                namespace: dapr-agents
              status:
                (readyReplicas > `0`): true
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: gateway
                namespace: dapr-agents
              status:
                (readyReplicas > `0`): true
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: diagrid-dashboard
                namespace: dapr-agents
              status:
                (readyReplicas > `0`): true
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: redisinsight
                namespace: dapr-agents
              status:
                (readyReplicas > `0`): true
        - assert:
            resource:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: dapr-agents-grafana
                namespace: dapr-agents
              status:
                (readyReplicas > `0`): true

    - name: check-dapr-components
      try:
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: statestore
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: pubsub
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: agent-pubsub
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: agent-memory
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: agent-registry
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: agent-runtimestatestore
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: agent-workflow
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: lockstore-redis
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: llm-provider
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: dapr.io/v1alpha1
              kind: Component
              metadata:
                name: external-webhook
                namespace: dapr-agents

    - name: check-secrets
      try:
        - assert:
            resource:
              apiVersion: v1
              kind: Secret
              metadata:
                name: llm-secret
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: v1
              kind: Secret
              metadata:
                name: kagent-openai
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: v1
              kind: Secret
              metadata:
                name: dapr-redis
                namespace: dapr-agents

    - name: check-services
      try:
        - assert:
            resource:
              apiVersion: v1
              kind: Service
              metadata:
                name: dapr-redis-master
                namespace: dapr-agents
        - assert:
            resource:
              apiVersion: v1
              kind: Service
              metadata:
                name: gateway
                namespace: dapr-agents
              spec:
                type: NodePort

    - name: check-configmaps
      try:
        - assert:
            resource:
              apiVersion: v1
              kind: ConfigMap
              metadata:
                name: gateway-config
                namespace: dapr-agents

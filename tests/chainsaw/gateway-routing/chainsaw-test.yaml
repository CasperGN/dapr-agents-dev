apiVersion: chainsaw.kyverno.io/v1alpha1
kind: Test
metadata:
  name: gateway-routing
spec:
  description: Validate gateway subdomain routing works for all services
  namespace: dapr-agents
  timeouts:
    assert: 15m
    exec: 15m
  steps:
    - name: check-subdomains
      try:
        - script:
            content: |
              PORT=$(kubectl get svc gateway -n dapr-agents -o jsonpath='{.spec.ports[0].nodePort}')
              echo "Testing via NodePort: $PORT"

              echo "Checking Diagrid Dashboard..."
              curl -s -H "Host: diagrid.localhost" http://localhost:$PORT | grep -i "diagrid"

              echo "Checking Redis Insight..."
              curl -s -H "Host: redis.localhost" http://localhost:$PORT | grep -i "redis"

              echo "Checking default landing page..."
              curl -s http://localhost:$PORT | grep "dapr-agents gateway"

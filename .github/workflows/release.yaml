name: Release

on:
  push:
    branches: [main]
    paths:
      - "dapr-agents/Chart.yaml"

permissions:
  contents: write
  packages: write

env:
  HELM_VERSION: "3.17.0"
  CHAINSAW_VERSION: "v0.2.12"
  REGISTRY: ghcr.io

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Detect if Chart.yaml version was bumped compared to latest tag
  # ---------------------------------------------------------------------------
  detect-version:
    name: Detect Version Bump
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for version bump
        id: check
        run: |
          CHART_VERSION=$(grep '^version:' dapr-agents/Chart.yaml | awk '{print $2}')
          echo "Chart.yaml version: $CHART_VERSION"

          # Get latest tag, default to 0.0.0 if none exist
          LATEST_TAG=$(git tag --sort=-v:refname | head -1 || echo "")
          if [ -z "$LATEST_TAG" ]; then
            LATEST_VERSION="0.0.0"
          else
            LATEST_VERSION="${LATEST_TAG#v}"
          fi
          echo "Latest released version: $LATEST_VERSION"

          # Compare versions using sort -V
          if [ "$CHART_VERSION" = "$LATEST_VERSION" ]; then
            echo "No version bump detected"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          elif [ "$(printf '%s\n%s' "$LATEST_VERSION" "$CHART_VERSION" | sort -V | tail -1)" = "$CHART_VERSION" ]; then
            echo "Version bump detected: $LATEST_VERSION -> $CHART_VERSION"
            echo "should_release=true" >> "$GITHUB_OUTPUT"
          else
            echo "Chart version ($CHART_VERSION) is not newer than latest tag ($LATEST_VERSION)"
            echo "should_release=false" >> "$GITHUB_OUTPUT"
          fi

          echo "version=$CHART_VERSION" >> "$GITHUB_OUTPUT"

  # ---------------------------------------------------------------------------
  # Job 2: Run full test suite (monitoring + kagent + dapr all enabled)
  # ---------------------------------------------------------------------------
  full-test:
    name: Full Stack Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: detect-version
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Install Chainsaw
        run: |
          curl -sSLo chainsaw.tar.gz \
            "https://github.com/kyverno/chainsaw/releases/download/${{ env.CHAINSAW_VERSION }}/chainsaw_linux_amd64.tar.gz"
          tar xzf chainsaw.tar.gz
          sudo mv chainsaw /usr/local/bin/

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: release-dapr-agents
          config: kind-config.yaml

      - name: Helm dependency update
        run: helm dependency update ./dapr-agents

      - name: Install full stack
        run: |
          helm upgrade --install dapr-agents ./dapr-agents \
            --namespace dapr-agents \
            --create-namespace \
            --set llm.apiKey=release-test-key \
            --wait \
            --timeout 15m

      - name: Run Chainsaw tests
        run: chainsaw test tests/chainsaw/core-install/ --report-format JSON --report-name release-test-results

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-test-results
          path: release-test-results.json

  # ---------------------------------------------------------------------------
  # Job 3: Create release, push OCI image, create git tag
  # ---------------------------------------------------------------------------
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-version, full-test]
    if: needs.detect-version.outputs.should_release == 'true'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Helm dependency update
        run: helm dependency update ./dapr-agents

      - name: Helm lint
        run: helm lint ./dapr-agents --set llm.apiKey=release-lint-key

      - name: Package chart
        run: helm package ./dapr-agents

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Push chart to OCI registry
        run: |
          helm push dapr-agents-${{ needs.detect-version.outputs.version }}.tgz \
            oci://${{ env.REGISTRY }}/${{ github.repository_owner }}/charts

      - name: Create git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.detect-version.outputs.version }}" \
            -m "Release v${{ needs.detect-version.outputs.version }}"
          git push origin "v${{ needs.detect-version.outputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.detect-version.outputs.version }}
          name: v${{ needs.detect-version.outputs.version }}
          generate_release_notes: true
          files: dapr-agents-${{ needs.detect-version.outputs.version }}.tgz
